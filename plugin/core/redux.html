<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序状态管理方案 | @wxa</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/wxa/logo-mini.png">
    <meta name="description" content="一个小程序框架">
    <link rel="preload" href="/wxa/assets/css/0.styles.b6722d83.css" as="style"><link rel="preload" href="/wxa/assets/js/app.547bea4d.js" as="script"><link rel="preload" href="/wxa/assets/js/4.bced5a66.js" as="script"><link rel="preload" href="/wxa/assets/js/42.bf4edef3.js" as="script"><link rel="preload" href="/wxa/assets/js/6.edbfb051.js" as="script"><link rel="prefetch" href="/wxa/assets/js/10.02534096.js"><link rel="prefetch" href="/wxa/assets/js/11.b3764145.js"><link rel="prefetch" href="/wxa/assets/js/12.3e41c7a7.js"><link rel="prefetch" href="/wxa/assets/js/13.05ffae7c.js"><link rel="prefetch" href="/wxa/assets/js/14.954e2714.js"><link rel="prefetch" href="/wxa/assets/js/15.664224a3.js"><link rel="prefetch" href="/wxa/assets/js/16.915b1004.js"><link rel="prefetch" href="/wxa/assets/js/17.6b8252d0.js"><link rel="prefetch" href="/wxa/assets/js/18.f423531e.js"><link rel="prefetch" href="/wxa/assets/js/19.fcd7c501.js"><link rel="prefetch" href="/wxa/assets/js/20.05628364.js"><link rel="prefetch" href="/wxa/assets/js/21.5649573d.js"><link rel="prefetch" href="/wxa/assets/js/22.e33d8b1a.js"><link rel="prefetch" href="/wxa/assets/js/23.f1ead2fd.js"><link rel="prefetch" href="/wxa/assets/js/24.9e7730a5.js"><link rel="prefetch" href="/wxa/assets/js/25.83624744.js"><link rel="prefetch" href="/wxa/assets/js/26.d69c4e82.js"><link rel="prefetch" href="/wxa/assets/js/27.f64269de.js"><link rel="prefetch" href="/wxa/assets/js/28.327456b6.js"><link rel="prefetch" href="/wxa/assets/js/29.2f28ce0e.js"><link rel="prefetch" href="/wxa/assets/js/30.835af20b.js"><link rel="prefetch" href="/wxa/assets/js/31.c82684c0.js"><link rel="prefetch" href="/wxa/assets/js/32.c4fafd3e.js"><link rel="prefetch" href="/wxa/assets/js/33.837c1a85.js"><link rel="prefetch" href="/wxa/assets/js/34.1325c0eb.js"><link rel="prefetch" href="/wxa/assets/js/35.05e11a5d.js"><link rel="prefetch" href="/wxa/assets/js/36.0a3d9709.js"><link rel="prefetch" href="/wxa/assets/js/37.fb2ed1d4.js"><link rel="prefetch" href="/wxa/assets/js/38.ec63a564.js"><link rel="prefetch" href="/wxa/assets/js/39.827e3ebf.js"><link rel="prefetch" href="/wxa/assets/js/40.164e8026.js"><link rel="prefetch" href="/wxa/assets/js/41.747c0eac.js"><link rel="prefetch" href="/wxa/assets/js/43.fc590d57.js"><link rel="prefetch" href="/wxa/assets/js/44.60f6d922.js"><link rel="prefetch" href="/wxa/assets/js/5.599f29f3.js"><link rel="prefetch" href="/wxa/assets/js/7.766964ec.js"><link rel="prefetch" href="/wxa/assets/js/8.61c528bb.js"><link rel="prefetch" href="/wxa/assets/js/9.1679f299.js"><link rel="prefetch" href="/wxa/assets/js/vendors~docsearch.e22b0772.js"><link rel="prefetch" href="/wxa/assets/js/vendors~notification.34e5902a.js">
    <link rel="stylesheet" href="/wxa/assets/css/0.styles.b6722d83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wxa/" class="home-link router-link-active"><!----> <span class="site-name">@wxa</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wxa/learn/guide/" class="nav-link">
  教程
</a></div><div class="nav-item"><a href="/wxa/core/" class="nav-link">
  CORE
</a></div><div class="nav-item"><a href="/wxa/cli/" class="nav-link">
  CLI
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CORE 运行时插件" class="dropdown-title"><span class="title">CORE 运行时插件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/validate.html" class="nav-link">
  Validate 表单校验
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/watch.html" class="nav-link">
  Watch 数据监听
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/redux.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redux 全局状态管理
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/log.html" class="nav-link">
  Log 日志上报
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CLI 预编译插件" class="dropdown-title"><span class="title">CLI 预编译插件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/uglifyjs.html" class="nav-link">
  UglifyJS 代码压缩
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/replace.html" class="nav-link">
  Replace 字符替换
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/copy.html" class="nav-link">
  Copy 静态资源引入
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/hijack.html" class="nav-link">
  hijack 事件劫持
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/minify-wxml.html" class="nav-link">
  Minify-wxml wxml压缩
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/postcss.html" class="nav-link">
  Postcss CSS预处理
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/da.html" class="nav-link">
  DA 依赖分析
</a></li></ul></div></div><div class="nav-item"><a href="https://genuifx.com/wxa/v0/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  1.x
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/wxajs/wxa" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wxa/learn/guide/" class="nav-link">
  教程
</a></div><div class="nav-item"><a href="/wxa/core/" class="nav-link">
  CORE
</a></div><div class="nav-item"><a href="/wxa/cli/" class="nav-link">
  CLI
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CORE 运行时插件" class="dropdown-title"><span class="title">CORE 运行时插件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/validate.html" class="nav-link">
  Validate 表单校验
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/watch.html" class="nav-link">
  Watch 数据监听
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/redux.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redux 全局状态管理
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/core/log.html" class="nav-link">
  Log 日志上报
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CLI 预编译插件" class="dropdown-title"><span class="title">CLI 预编译插件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/uglifyjs.html" class="nav-link">
  UglifyJS 代码压缩
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/replace.html" class="nav-link">
  Replace 字符替换
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/copy.html" class="nav-link">
  Copy 静态资源引入
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/hijack.html" class="nav-link">
  hijack 事件劫持
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/minify-wxml.html" class="nav-link">
  Minify-wxml wxml压缩
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/postcss.html" class="nav-link">
  Postcss CSS预处理
</a></li><li class="dropdown-item"><!----> <a href="/wxa/plugin/cli/da.html" class="nav-link">
  DA 依赖分析
</a></li></ul></div></div><div class="nav-item"><a href="https://genuifx.com/wxa/v0/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  1.x
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/wxajs/wxa" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>小程序状态管理方案</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/wxa/plugin/core/redux.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wxa/plugin/core/redux.html#基本用法" class="sidebar-link">基本用法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#挂载插件" class="sidebar-link">挂载插件</a></li><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#获取全局状态" class="sidebar-link">获取全局状态</a></li><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#个性化页面数据" class="sidebar-link">个性化页面数据</a></li></ul></li><li><a href="/wxa/plugin/core/redux.html#分包用法" class="sidebar-link">分包用法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#挂载插件-2" class="sidebar-link">挂载插件</a></li><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#动态添加分包-reducer" class="sidebar-link">动态添加分包 Reducer</a></li></ul></li><li><a href="/wxa/plugin/core/redux.html#调试-redux" class="sidebar-link">调试 Redux</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wxa/plugin/core/redux.html#持久化数据" class="sidebar-link">持久化数据</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wxa/plugin/core/redux.html#实时日志" class="sidebar-link">实时日志</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/wxa/plugin/core/redux.html#配置" class="sidebar-link">配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#reducers" class="sidebar-link">reducers</a></li><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#middlewares" class="sidebar-link">middlewares</a></li><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#initialstate" class="sidebar-link">initialState</a></li><li class="sidebar-sub-header"><a href="/wxa/plugin/core/redux.html#debug" class="sidebar-link">debug</a></li></ul></li><li><a href="/wxa/plugin/core/redux.html#技术细节" class="sidebar-link">技术细节</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://www.npmjs.com/package/@wxa/redux" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/npm/v/@wxa/redux/latest.svg" alt="NPM version"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <img src="https://img.shields.io/bundlephobia/minzip/@wxa/redux/latest.svg" alt="npm bundle size (minified + gzip)"></p> <p>redux 小程序适配方案。在小程序开发中使用 <code>redux</code> 管理全局状态。</p> <p>尽管小程序入门门槛非常之低，但是在项目不停的迭代过程中，不可避免的项目代码复杂度也会越来越高，从前我们可以将跨页面数据管理在<a href="/wxa/core/API.html#storage">Storage</a>或者<a href="/wxa/core/API.html#sessionstorage">SessionStorage</a>中，利用一定的代码规范来管理不同页面不同开发者的数据，但随着时间的推移这种方式会造成代码、数据过于分散，且容易出错覆盖。再者每个页面间都需要手动的去 <code>storage</code> 读取数据，略显繁琐。</p> <p>当项目开始变得复杂，我们想要统一的管理起状态数据，自动的同步、分发数据到需要的页面、组件（<code>Reactive</code>）。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 使用npm安装</span>
<span class="token function">npm</span> i -S @wxa/redux
<span class="token comment"># 使用yarn安装</span>
<span class="token function">yarn</span> <span class="token function">add</span> @wxa/redux
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h2> <h3 id="挂载插件"><a href="#挂载插件" class="header-anchor">#</a> 挂载插件</h3> <p>在<code>app.js</code>/<code>app.wxa</code>中挂载插件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.js or app.wxa</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>App<span class="token punctuation">,</span> wxa<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入插件方法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>wxaRedux<span class="token punctuation">,</span> combineReducers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span>
<span class="token keyword">import</span> promiseMiddleware <span class="token keyword">from</span> <span class="token string">'redux-promise'</span><span class="token punctuation">;</span>

<span class="token comment">// 注册插件</span>
wxa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>wxaRedux<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    reducers<span class="token operator">:</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token operator">...</span>your reducer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>promiseMiddleware<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

@App
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>注册完 redux 插件之后，将会自动的调用 <code>redux.createStore</code> 创建一个用于存储全局状态数据 <code>store</code>，并且插件会在自动的挂载 <code>store</code> 到 App、Component、Page 实例中 <code>$store</code> 。</p> <p>通过 <code>this.$store.getState()</code>可以获得所有全局状态。</p> <p>通过 <code>this.$store.dispatch()</code>可以提交一个状态修改的 action。</p> <p>更详细的 <a href="https://redux.js.org/api/store" target="_blank" rel="noopener noreferrer">store api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="获取全局状态"><a href="#获取全局状态" class="header-anchor">#</a> 获取全局状态</h3> <p>在页面/组件类中定义 <code>mapState</code> 对象，指定关联的全局状态（在<code>react</code>中叫<code>connect</code>）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Page<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>

@Page
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token punctuation">{</span>
    mapState <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">todolist$</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>state<span class="token punctuation">.</span>todo<span class="token punctuation">,</span>
        <span class="token function-variable function">userInfo$</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>state<span class="token punctuation">.</span>userInfo
    <span class="token punctuation">}</span>

    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// dispatch change state.</span>
        <span class="token comment">// todo list will auto add one.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'Add_todo_list'</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token string">'coding today'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后再<code>template</code>中就可以直接使用映射的数据了。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span><span class="token punctuation">&gt;</span></span>{{userInfo$.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{{todolist$}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{key+1}}{{item}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>得益于 <code>@wxa/core</code> 的 <a href="/wxa/core/API.html#vm-diff">diff方法</a>，redux在同步数据的时候只会增量的修改数据，而不是全量覆盖 😁</p> <h4 id="在任意位置获取全局状态数据"><a href="#在任意位置获取全局状态数据" class="header-anchor">#</a> 在任意位置获取全局状态数据</h4> <p>编写一些通用的基础函数提供给页面调用的时候，可能会需要从 <code>store</code> 中读取相应数据做处理。 例如在我们需要在所有请求的 postdata 中统一的加上用户的基本信息，可以这么实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 任意 api.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>fetch<span class="token punctuation">}</span> <span class="token keyword">from</span> '@wxa<span class="token operator">/</span>core`<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>getStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">const</span> <span class="token function-variable function">customFetch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>idNo<span class="token punctuation">,</span> name<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>UserModel<span class="token punctuation">;</span>

    <span class="token comment">// 每个请求自动添加用户</span>
    args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        idNo<span class="token punctuation">,</span> name
        <span class="token operator">...</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="个性化页面数据"><a href="#个性化页面数据" class="header-anchor">#</a> 个性化页面数据</h3> <p>有时我们可能需要临时改写一下数据用于展示，实现类似 <code>vue</code> <code>computed</code> 的效果，此时我们可以相应的改造 mapState。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    mapState <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function">userInfo$</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> model <span class="token operator">=</span> state<span class="token punctuation">.</span>UserModel<span class="token punctuation">;</span>

            <span class="token comment">// 自动掩码用户的身份证、姓名</span>
            <span class="token comment">// diff 数据并自动调用 setData</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$diff</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                idNoCover<span class="token operator">:</span> model<span class="token punctuation">.</span>idNo<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([\d]{4})(\d{10})([\dxX]{4})/</span><span class="token punctuation">,</span> <span class="token string">'$1***$3'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> model
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="分包用法"><a href="#分包用法" class="header-anchor">#</a> 分包用法</h2> <p>当小程序应用开始使用<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages.html" target="_blank" rel="noopener noreferrer">分包技术<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的时候，redux 方案也需要相应的做出优化，分包有以下特点：</p> <blockquote><p>引用原则</p> <ul><li>packageA 无法 require packageB JS 文件，但可以 require app、自己 package 内的 JS 文件</li> <li>packageA 无法 import packageB 的 template，但可以 require app、自己 package 内的 template</li> <li>packageA 无法使用 packageB 的资源，但可以使用 app、自己 package 内的资源</li></ul></blockquote> <p>即当分包 A 定义了自己业务逻辑的数据 model 之后，且该 model 无法被其他分包复用，则我们完全可以把对应 model 放到分包的页面中，懒加载对应 <code>redux.reducer</code>，以此减少主包体积。</p> <p>为了做到懒加载对应的 reducer，我们需要在改造一下我们的代码。</p> <h3 id="挂载插件-2"><a href="#挂载插件-2" class="header-anchor">#</a> 挂载插件</h3> <p>在<code>app.js</code>/<code>app.wxa</code>中，改造 <code>reducer</code> 的注册方式。</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// app.js or app.wxa</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>App<span class="token punctuation">,</span> wxa<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入插件方法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>wxaRedux<span class="token punctuation">,</span> combineReducers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span>
<span class="token keyword">import</span> promiseMiddleware <span class="token keyword">from</span> <span class="token string">'redux-promise'</span><span class="token punctuation">;</span>

<span class="token comment">// 注册插件</span>
wxa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>wxaRedux<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// reducers: combineReducers(...your reducer),</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
        UserModel<span class="token operator">:</span> userReducer<span class="token punctuation">,</span>
        AppModel<span class="token operator">:</span> appReducer<span class="token punctuation">,</span>
        <span class="token operator">...</span>your reducer
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>promiseMiddleware<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

@App
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="动态添加分包-reducer"><a href="#动态添加分包-reducer" class="header-anchor">#</a> 动态添加分包 Reducer</h3> <p>假设我们在分包 A 中定义了专门用于订单处理的 <code>reducer</code>，分包入口页面为 <code>subpages/A/pages/board</code>。</p> <p>在分包页面被使用之前我们需要动态的注册一个新的 <code>reducer</code>。</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br></div><pre class="language-js"><code><span class="token comment">// subpages/A/pages/board</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>reducerRegistry<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AOrderModel <span class="token keyword">from</span> <span class="token string">'/subpages/A/models/order.model.js'</span><span class="token punctuation">;</span>

<span class="token comment">// 注册对应的数据 model</span>
reducerRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'AOrderModel'</span><span class="token punctuation">,</span> AOrderModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>注册完毕之后，后续所有分包 A 的页面都可以正常的使用 <code>mapState</code> 中映射页面需要使用的状态数据。</p> <h2 id="调试-redux"><a href="#调试-redux" class="header-anchor">#</a> 调试 Redux</h2> <p><code>@wxa/redux</code> 提供了小程序 <code>redux-remote-devtools</code> 的适配代码。稍微改造一下我们的挂载插件部分的代码即可使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>App<span class="token punctuation">,</span> wxa<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入插件方法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>wxaRedux<span class="token punctuation">,</span> combineReducers<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> composeWithDevTools <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux/libs/remote-redux-devtools.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> promiseMiddleware <span class="token keyword">from</span> <span class="token string">'redux-promise'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> composeEnhancers <span class="token operator">=</span> <span class="token function">composeWithDevTools</span><span class="token punctuation">(</span><span class="token punctuation">{</span> realtime<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token number">8000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册插件</span>
wxa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>wxaRedux<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// reducers: combineReducers(...your reducer),</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
        UserModel<span class="token operator">:</span> userReducer<span class="token punctuation">,</span>
        AppModel<span class="token operator">:</span> appReducer<span class="token punctuation">,</span>
        <span class="token operator">...</span>your reducer
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    middlewares<span class="token operator">:</span> <span class="token function">composeEnhancers</span><span class="token punctuation">(</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>promiseMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>打开开发者工具不校验合法域名开关，就可以正常使用 <code>redux-devtools</code> 了。</p> <p>由于 <code>devtools</code> 仅用于开发阶段，我们可以利用 <code>wxa</code> 提供的依赖分析能力，按需引入。</p> <p>改写上续配置如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>App<span class="token punctuation">,</span> wxa<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>
<span class="token comment">// 引入插件方法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>wxaRedux<span class="token punctuation">,</span> combineReducers<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span>
<span class="token keyword">import</span> promiseMiddleware <span class="token keyword">from</span> <span class="token string">'redux-promise'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">composeEnhancers</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> composeWithDevTools <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@wxa/redux/libs/remote-redux-devtools.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>composeWithDevTools<span class="token punctuation">;</span>
    composeEnhancers <span class="token operator">=</span> <span class="token function">composeWithDevTools</span><span class="token punctuation">(</span><span class="token punctuation">{</span> realtime<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> port<span class="token operator">:</span> <span class="token number">8000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注册插件</span>
wxa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>wxaRedux<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// reducers: combineReducers(...your reducer),</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
        UserModel<span class="token operator">:</span> userReducer<span class="token punctuation">,</span>
        AppModel<span class="token operator">:</span> appReducer<span class="token punctuation">,</span>
        <span class="token operator">...</span>your reducer
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    middlewares<span class="token operator">:</span> <span class="token function">composeEnhancers</span><span class="token punctuation">(</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>promiseMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如上配置，当 <code>process.env.NODE_ENV</code> 设置为生产环境的时候，<code>@wxa/redux/libs/remote-redux-devtools.js</code> 将不会被打包进 <code>dist</code></p> <h2 id="持久化数据"><a href="#持久化数据" class="header-anchor">#</a> 持久化数据</h2> <p>某些场景，为了用户体验，我们需要将对应数据缓存下来，方便下次用户可以直接看到对应页面，此时我们需要将 <code>store</code> 的数据缓存下来，这里我们使用 <a href="https://github.com/rt2zz/redux-persist" target="_blank" rel="noopener noreferrer"><code>redux-persist</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 用于持久化数据。</p> <p>示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>wxa<span class="token punctuation">,</span> App<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> wxaRedux <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> wxPersistStorage <span class="token keyword">from</span> <span class="token string">'@wxa/redux/libs/wx.storage.min.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>persistStore<span class="token punctuation">,</span> persistReducer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-persist'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> orderModel <span class="token keyword">from</span> <span class="token string">'./order.model.js'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> persistOrderModel <span class="token operator">=</span> <span class="token function">persistReducer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    key<span class="token operator">:</span> <span class="token string">'orderModel'</span><span class="token punctuation">,</span>
    storage<span class="token operator">:</span> wxPersistStorage<span class="token punctuation">,</span>
    timeout<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 超时时间，设置为 null</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> orderModel<span class="token punctuation">)</span><span class="token punctuation">;</span>

wxa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>wxaRedux<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
        orderModel<span class="token operator">:</span> persistOrderModel
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

@App
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 冷启动开始就加载缓存数据</span>
        <span class="token function">persistStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>$storeReady<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="实时日志"><a href="#实时日志" class="header-anchor">#</a> 实时日志</h2> <p>我们可以结合小程序<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/realtimelog/" target="_blank" rel="noopener noreferrer">实时日志<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和 <code>redux-logger</code> 一起使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>wxa<span class="token punctuation">,</span> App<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@wxa/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createLogger<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-logger'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> wxaRedux <span class="token keyword">from</span> <span class="token string">'@wxa/redux'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> log <span class="token operator">=</span> wx<span class="token punctuation">.</span>getRealtimeLogManager <span class="token operator">?</span> wx<span class="token punctuation">.</span><span class="token function">getRealtimeLogManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> console<span class="token punctuation">;</span>

<span class="token keyword">let</span> logger <span class="token operator">=</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    logger<span class="token operator">:</span> log
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

wxa<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>wxaRedux<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span>your reducers<span class="token punctuation">}</span><span class="token punctuation">,</span>
    middlewares<span class="token operator">:</span> <span class="token punctuation">[</span>logger<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>配置完毕之后，项目中所有的 <code>Action</code> 日志都将上报到微信的实时日志后台，开发者可以登录 mp.weixin.qq.com 查看用户所有操作记录。</p> <h2 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h2> <h3 id="reducers"><a href="#reducers" class="header-anchor">#</a> reducers</h3> <ul><li><strong>类型</strong>:
<ul><li><strong>Function</strong> <code>combineReducers(...reducer)</code>的返回</li> <li><strong>Object</strong> <code>reducer</code> 列表，用于动态注册场景</li></ul></li></ul> <h3 id="middlewares"><a href="#middlewares" class="header-anchor">#</a> middlewares</h3> <ul><li><strong>类型</strong>:
<ul><li><strong>Array</strong> redux 中间件列表</li> <li><strong>Function</strong> <code>applyMiddleware(...middlewares)</code>的返回</li></ul></li></ul> <h3 id="initialstate"><a href="#initialstate" class="header-anchor">#</a> initialState</h3> <ul><li><strong>类型</strong>:
<ul><li><strong>any</strong> reducer 初始状态，参考 <a href="https://redux.js.org/api/createstore" target="_blank" rel="noopener noreferrer"><code>redux 文档</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul> <h3 id="debug"><a href="#debug" class="header-anchor">#</a> debug</h3> <ul><li><strong>类型</strong>:
<ul><li><strong>Boolean</strong> <code>false</code></li></ul></li></ul> <p>是否打印插件日志</p> <h2 id="技术细节"><a href="#技术细节" class="header-anchor">#</a> 技术细节</h2> <p><code>wxa/redux</code>根据不同的实例类型有不同的任务，在App层，我们需要创建一个<code>store</code>并挂载到app中，在<code>Page</code>和<code>Component</code>层，我们做了更多细节处理。</p> <ul><li><p><strong>App Level</strong><br>
创建<code>store</code>，应用redux的中间件，挂载<code>store</code>到App实例。</p></li> <li><p><strong>Page Level</strong><br>
在不同的生命周期函数，有不同的处理。</p> <ul><li><code>onLoad</code> 根据<code>mapState</code>订阅<code>store</code>的数据，同时挂载一个<code>unsubscribe</code>方法到实例。</li> <li><code>onShow</code> 标记页面实例<code>$$isCurrentPage</code>为<code>true</code>, 同时做一次状态同步。因为有可能状态在其他页面做了改变。</li> <li><code>onHide</code> 重置<code>$$isCurrentPage</code>，这样子页面数据就不会自动刷新了。</li> <li><code>onUnload</code> 调用<code>$unsubscribe</code>取消订阅状态</li></ul></li></ul> <ol start="3"><li><strong>Component Level</strong><br>
针对组件生命周期做一些单独处理
<ul><li><code>created</code> 挂载<code>store</code></li> <li><code>attached</code> 订阅状态，并同步状态到组件。</li> <li><code>detached</code> 取消订阅</li></ul></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/wxajs/wxa/edit/master/docs/plugin/core/redux.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次编辑时间:</span> <span class="time">2020-7-5</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/wxa/assets/js/app.547bea4d.js" defer></script><script src="/wxa/assets/js/4.bced5a66.js" defer></script><script src="/wxa/assets/js/42.bf4edef3.js" defer></script><script src="/wxa/assets/js/6.edbfb051.js" defer></script>
  </body>
</html>
